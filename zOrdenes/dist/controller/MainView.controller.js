sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox"],function(e,t,o,s){"use strict";return e.extend("zOrdenes.controller.MainView",{onInit(){this.oTable=this.byId("table");this.oFileUploader=this.byId("_IDGenFileUploader");this.oButtonDownload=this.byId("oButtonDownload");this.oColumn=this.byId("FechaEntrega");this.oCountsModel=new sap.ui.model.json.JSONModel({all:0,opened:0,PorFacturar:0,Facturado:0});this.getView().setModel(this.oCountsModel,"countsModel");this._filters={date:[],search:[]}},onAfterRendering:function(){this.contadorgeneral()},onPress:function(e){const t=e.getSource();const o=t.getBindingContext("localModel");const s=o.getProperty("NoPedido");this.getOwnerComponent().getRouter().navTo("object",{orderId:s})},onQuickFilter:function(e){const t=e.getParameter("key");switch(t){case"all":this._showAllItems();break;case"opened":this._showOpenItems();break;case"toinvoice":this._showToInvoiceItems();break;case"invoiced":this._showInvoicedItems();break;default:console.log(`Filtro no reconocido: ${t}`);this._showAllItems()}},_showOpenItems:function(){const e=this.oTable.getBinding("items");const s=new t("Pendiente",o.EQ,true);this._aCurrentFilters=[s];e.filter(this._aCurrentFilters);this.oTable.setMode("None");this.oFileUploader.setVisible(false);this.oButtonDownload.setVisible(false);this.oColumn.setVisible(false)},_showAllItems:function(){const e=this.oTable.getBinding("items");this._aCurrentFilters=[];e.filter([]);this.oTable.setMode("None");this.oFileUploader.setVisible(false);this.oButtonDownload.setVisible(false);this.oColumn.setVisible(true)},_showToInvoiceItems:function(){const e=this.oTable.getBinding("items");const s=new t("PorFacturar",o.EQ,true);this._aCurrentFilters=[s];e.filter(this._aCurrentFilters);this.oColumn.setVisible(true);this.oTable.setMode("SingleSelectLeft");this.oFileUploader.setVisible(true);this.oButtonDownload.setVisible(false)},_showInvoicedItems:function(){const e=this.oTable.getBinding("items");const s=new t("Facturado",o.EQ,true);this._aCurrentFilters=[s];e.filter(this._aCurrentFilters);this.oTable.setMode("SingleSelectLeft");this.oFileUploader.setVisible(false);this.oButtonDownload.setVisible(true);this.oColumn.setVisible(true)},applySearchFilter:function(e){const t=["NoPedido","Solicitante"];e=e.trim().toLowerCase();if(e){const o=t.map(t=>new sap.ui.model.Filter({path:t,operator:sap.ui.model.FilterOperator.Contains,value1:e,caseSensitive:false}));this._filters.search=[new sap.ui.model.Filter({filters:o,and:false})]}else{this._filters.search=[]}this.applyAllFilters()},applyDateFilter:function(){this.oDateRange=this.byId("filterdate");const e=this.oDateRange.getDateValue();const s=this.oDateRange.getSecondDateValue();if(e&&s){const a=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});const i=a.format(e);const n=a.format(s);this._filters.date=[new t("Fechadeentrega",o.BT,i,n)]}else{this._filters.date=[]}this.applyAllFilters()},applyAllFilters:function(){const e=this.oTable.getBinding("items");const t=[...this._filters.date,...this._filters.search];e.filter(t,"Application")},onSearch:function(e){const t=e.getSource().getValue();this.applySearchFilter(t)},onSearchDate:function(){this.applyDateFilter()},contadorgeneral:function(){const e=this.getView().getModel("localModel");const t=e.getProperty("/Pedidos");this.oCountsModel.setData({all:t.length,opened:t.filter(e=>e.Pendiente===true).length,PorFacturar:t.filter(e=>e.PorFacturar===true).length,Facturado:t.filter(e=>e.Facturado===true).length})},currencyFormat:function(e){var t=sap.ui.core.format.NumberFormat.getCurrencyInstance({decimals:2});return t.format(e)},onSelectionChange:function(e){this.oFileUploader.setEnabled(true);this.oFileUploader.clear();const t=e.getParameter("listItem");const o=t.getBindingContext("localModel");this.oSelectedItem=o.getObject();console.log("Item de tabla seleccionado:",this.oSelectedItem);this.RFCR=o.getObject("RFCR");this.RFCE=o.getObject("RFCE");var s=o.getObject("Posiciones");var a=s[0];this.Moneda=a.Moneda;this.MetodoPago=o.getObject("MetodoPago");var i=o.getObject("Subtotal");this.Subtotal=i.toFixed(2);var n=o.getObject("TotalImpuestosTrasladados");this.TotalImTr=n.toFixed(2);var l=o.getObject("Total");this.Total=l.toFixed(2);console.log("RFC DEL ITEM:",this.RFCR);console.log("Tipo de moneda:",this.Moneda);console.log("Metodo de pago:",this.MetodoPago);console.log("Subtotal:",this.Subtotal);console.log("Total Impuestos Trasladados:",this.TotalImTr);console.log("Total:",this.Total)},onFileUploaderChange:function(e){const t=e.getSource();var o=t.oFileUpload.files;var a=Array.from(o);if(a.length>2){s.error("Solo se permiten seleccionar un m√°ximo de 2 archivos.");t.clear();return}var i=null;var n=null;a.forEach(function(e){if(e.type==="text/xml"){i=e}else if(e.type==="application/pdf"){n=e}else{s.error("Solo se permiten archivos XML y PDF.");return}});if(!i||!n){s.error("Por favor, selecciona un archivo XML y un PDF.");return}var l=new FileReader;l.onload=function(e){var t=e.target.result;this._verifyFile(t)}.bind(this);l.readAsText(i);t.clear()},_verifyFile:function(e){var t=new DOMParser;var o=t.parseFromString(e,"text/xml");this.RFCRXML=o.getElementsByTagName("cfdi:Receptor")[0].getAttribute("Rfc");this.RFCEXML=o.getElementsByTagName("cfdi:Emisor")[0].getAttribute("Rfc");this.FolioFXML=o.getElementsByTagName("tfd:TimbreFiscalDigital")[0].getAttribute("UUID");var a=o.getElementsByTagName("cfdi:Comprobante")[0].getAttribute("Moneda");var i=o.getElementsByTagName("cfdi:Comprobante")[0].getAttribute("MetodoPago");var n=o.getElementsByTagName("cfdi:Traslado")[0].getAttribute("Base");var l=o.getElementsByTagName("cfdi:Impuestos");var r=Array.from(l).find(e=>e.hasAttribute("TotalImpuestosTrasladados"));var c=r.getAttribute("TotalImpuestosTrasladados");this.TotalXML=o.getElementsByTagName("cfdi:Comprobante")[0].getAttribute("Total");console.log("RFCEXML:",this.RFCEXML);console.log("RFCR:",this.RFCRXML);console.log("SubtotalXML:",n);console.log("IVAXML:",c);console.log("TotalXML",this.TotalXML);const d=[];if(this.RFCRXML!==this.RFCR){d.push("El RFC del Receptor no coincide.")}if(this.RFCEXML!==this.RFCE){d.push("El RFC del Emisor no coincide.")}if(this.FolioFXML.length<1&&this.FolioFXML.length>40){d.push("El Folio Fiscal debe de tener entre 1 a 40 caracteres alfan√∫mericos.")}if(a!==this.Moneda){d.push("El tipo de Moneda no coicide.")}if(i!==this.MetodoPago){d.push("Metodo de Pago diferente.")}if(n!==this.Subtotal){d.push("El subtotal no coincide.")}if(c!==this.TotalImTr){d.push("IVA incorrecto")}if(this.TotalXML!==this.Total){d.push("El Total no coincide.")}if(d.length>0){const e="Error al cargar los archivos.\n"+"Se encontraron los siguientes problemas:\n\n"+d.join("\n");s.error(e);return false}else{this.callSATService();this.onClean()}},callSATService:function(){var e=this;var t=jQuery.sap.getModulePath("zordenes");var o="/api/proxy/";var s=`\n            <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"\n                xmlns:tem="http://tempuri.org/">\n                <soapenv:Header/>\n                <soapenv:Body>\n                    <tem:Consulta>\n                        <tem:expresionImpresa><![CDATA[?re=${this.RFCEXML}&rr=${this.RFCRXML}&tt=${this.TotalXML}&id=${this.FolioFXML}]]></tem:expresionImpresa>\n                    </tem:Consulta>\n                </soapenv:Body>\n            </soapenv:Envelope>\n            `;$.ajax({url:o,type:"POST",dataType:"xml",contentType:"text/xml; charset=utf-8",data:s,headers:{SOAPAction:"http://tempuri.org/IConsultaCFDIService/Consulta"},success:function(t){var o=t;var s=o.getElementsByTagName("a:Estado")[0]?.textContent||"";var a=o.getElementsByTagName("a:CodigoEstatus")[0]?.textContent||"";var i=o.getElementsByTagName("a:EsCancelable")[0]?.textContent||"";var n=o.getElementsByTagName("a:EstatusCancelacion")[0]?.textContent||"";if(!s){sap.m.MessageBox.error("‚ùå No se pudieron extraer los datos de la respuesta del SAT.");return}if(s==="Vigente"||s==="Timbrado"){e.oSelectedItem.PorFacturar=false;e.oSelectedItem.Facturado=true;sap.m.MessageBox.information("‚úÖ Archivos subidos correctamente.\n\n"+"Respuesta del SAT:\n"+"üìÑ Estado: "+s+"\n"+"üìå C√≥digo Estatus: "+a+"\n"+"üîÑ Es Cancelable: "+i)}else{sap.m.MessageBox.information("‚ùå No es posible cargar la factura.\n\n"+"Respuesta del SAT:\n"+"üìÑ Estado: "+s+"\n"+"üìå C√≥digo Estatus: "+a+"\n"+"üîÑ Es Cancelable: "+i+"\n"+"üö´ Estatus de Cancelaci√≥n: "+n)}e.contadorgeneral()},error:function(){sap.m.MessageBox.error("Error al conectar con el servicio del SAT.")}})},onClean:function(){this.oFileUploader.clear();this.oFileUploader.setEnabled(false);this.oTable.removeSelections()},onClearDateRange:function(){this.oDateRange.setDateValue(null);this.oDateRange.setSecondDateValue(null);this._filters.date=[];this.applyAllFilters()}})});
//# sourceMappingURL=MainView.controller.js.map